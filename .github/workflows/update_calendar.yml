name: Update Calendar Data

on:
  workflow_dispatch:
    inputs:
      entry_data:
        description: 'JSON string of the new/updated entry'
        required: true

jobs:
  update-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Update data.json
        run: |
          python3 -c "
          import json, os
          new_entry = json.loads('${{ github.event.inputs.entry_data }}')
          
          # è®€å–ç¾æœ‰è³‡æ–™
          if os.path.exists('data.json'):
              with open('data.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
          else:
              data = []

          # æ›´æ–°æˆ–æ–°å¢
          updated = False
          for i, item in enumerate(data):
              if item['date'] == new_entry['date']:
                  data[i] = new_entry
                  updated = True
                  break
          if not updated:
              data.append(new_entry)

          # æ’åº
          data.sort(key=lambda x: x['date'])

          # å­˜å›
          with open('data.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, indent=2, ensure_ascii=False)
          "

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git commit -m "ğŸ“… æ›´æ–°é€±æ›†: ${{ github.event.inputs.entry_data }}" || exit 0
          git push

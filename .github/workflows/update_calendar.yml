name: Update Calendar Data

on:
  workflow_dispatch:
    inputs:
      entry_data:
        description: 'JSON string of the new/updated entry'
        required: true

jobs:
  update-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç¢ºä¿æœ‰å¯«å…¥æ¬Šé™
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # ç¢ºä¿æŠ“å–çš„æ˜¯æœ€æ–°ä»£ç¢¼
          fetch-depth: 0

      - name: Update data.json
        # å°‡è¼¸å…¥è³‡æ–™è½‰å­˜ç‚ºç’°å¢ƒè®Šæ•¸ï¼Œé¿å… shell çš„å¼•è™Ÿè§£æå•é¡Œ
        env:
          INPUT_DATA: ${{ github.event.inputs.entry_data }}
        run: |
          python3 -c "
          import json, os, sys

          file_path = 'data.json'
          try:
              # å¾ç’°å¢ƒè®Šæ•¸è®€å– JSON
              new_entry = json.loads(os.environ['INPUT_DATA'])
              print(f'Received new entry: {new_entry}')

              # è®€å–ç¾æœ‰æª”æ¡ˆ
              if os.path.exists(file_path):
                  with open(file_path, 'r', encoding='utf-8') as f:
                      data = json.load(f)
              else:
                  data = []

              # æ›´æ–°é‚è¼¯
              updated = False
              for i, item in enumerate(data):
                  # ä¾æ“šæ—¥æœŸæ¯”å°ï¼Œå¦‚æœæ—¥æœŸä¸€æ¨£å°±è¦†è“‹
                  if item.get('date') == new_entry['date']:
                      data[i] = new_entry
                      updated = True
                      print(f'Updated existing entry for date: {new_entry[ \"date\" ]}')
                      break
              
              if not updated:
                  data.append(new_entry)
                  print(f'Added new entry for date: {new_entry[ \"date\" ]}')

              # é‡æ–°æ’åº
              data.sort(key=lambda x: x['date'])

              # å„²å­˜å›æª”æ¡ˆ
              with open(file_path, 'w', encoding='utf-8') as f:
                  json.dump(data, f, indent=2, ensure_ascii=False)
              
              print('Successfully wrote to data.json')
          except Exception as e:
              print(f'Error processing JSON: {e}')
              sys.exit(1)
          "

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦çœŸçš„æœ‰è®Šå‹•
          git status
          
          git add data.json
          # åªæœ‰åœ¨æœ‰è®Šå‹•æ™‚æ‰ commitï¼Œé¿å…ç©º commit å ±éŒ¯
          if git diff --staged --quiet; then
            echo "No changes detected in data.json. Skipping commit."
          else
            git commit -m "ğŸ“… Update Calendar: $(date +'%Y-%m-%d %H:%M')"
            git push origin main
          fi
